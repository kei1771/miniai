<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MiniPix — AI 그림 갤러리 (Fixed)</title>
<style>
:root{
  --bg:#fafbfd; --card:#fff; --muted:#6b7280; --accent:#2b6ef6; --danger:#c53;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Noto Sans KR',sans-serif;background:var(--bg);color:#111;-webkit-font-smoothing:antialiased}
.topbar{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid #eef2ff;background:#fff;position:sticky;top:0;z-index:60}
.brand{font-weight:700;color:var(--accent);text-decoration:none;font-size:16px;cursor:pointer}
.tools{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap;position:relative}
.btn{padding:8px 10px;border-radius:8px;border:1px solid #e6e9f2;background:#fff;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff;border:0}
.btn.danger{border-color:#f8d3d3;color:var(--danger)}
.container{max-width:1100px;margin:12px auto;padding:0 12px}
.header-sub{display:flex;gap:8px;align-items:center;margin:8px 0}
.view-toggle{display:flex;gap:6px}
.view-toggle button{padding:6px 10px;border-radius:8px;border:1px solid #e6e9f2;background:#fff}
.grid-toggle{display:flex;gap:6px;margin-left:12px}
.gallery{display:grid;gap:12px}
.card{background:#fff;border-radius:12px;overflow:hidden;border:1px solid #f0f3fb;cursor:pointer;position:relative;display:flex;flex-direction:column}
.thumb-wrap{flex:1;display:flex;align-items:center;justify-content:center;overflow:hidden;background:#f6f8fb}
.card img.thumb{width:100%;height:100%;object-fit:cover;display:block}
.hover{position:absolute;inset:auto 0 0 0;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.35));color:#fff;padding:10px;display:flex;flex-direction:column;justify-content:flex-end}
.hover .title{font-weight:600}
.hover .meta{font-size:12px;color:#e6eefc;margin-top:6px}
.empty{text-align:center;color:var(--muted);padding:30px}
.post-page{background:#fff;padding:14px;border-radius:10px;border:1px solid #eef2ff;margin-bottom:24px}
.image-stack{display:flex;flex-direction:column;gap:12px;margin:12px 0}
.image-stack img{width:100%;height:auto;border-radius:8px;display:block}
.post-body{white-space:pre-wrap;color:#222;margin-top:10px}
.tags{margin-top:8px}
.tag{display:inline-block;background:#eef2ff;color:var(--accent);padding:6px 8px;border-radius:6px;margin-right:6px;font-size:13px}
.editor{display:flex;flex-direction:column;gap:10px;background:#fff;padding:12px;border-radius:10px;border:1px solid #eef2ff}
input,textarea,select{padding:8px;border-radius:8px;border:1px solid #e6e9f2;font-size:14px}
.file{display:inline-block;padding:8px 12px;border-radius:8px;border:1px dashed #dfe7ff;background:#fbfcff;cursor:pointer}
.preview{display:flex;gap:8px;flex-wrap:wrap}
.preview img{width:96px;height:96px;object-fit:cover;border-radius:8px}
.row{display:flex;gap:8px;align-items:center}
.small{font-size:13px;color:var(--muted)}
.toolbar-search{display:flex;gap:8px;align-items:center;background:#fff;padding:6px;border-radius:8px;border:1px solid #eef2ff}
.input-search{padding:8px;border-radius:8px;border:1px solid #e6e9f2}
.carousel-thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.carousel-thumbs img{width:64px;height:64px;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid transparent}
.nsfw-badge{position:absolute;left:8px;top:8px;background:#ffefd5;color:#b24;border-radius:6px;padding:4px 6px;font-size:12px;border:1px solid #ffd6a6}
.menu-toggle{display:none;padding:8px;border-radius:8px;border:1px solid #eef2ff;background:#fff;cursor:pointer}
.more-toggle{position:relative}
.more-menu{position:absolute;right:0;top:40px;background:#fff;padding:8px;border-radius:8px;border:1px solid #eef2ff;box-shadow:0 8px 20px rgba(0,0,0,0.08);display:none;z-index:200}
.more-menu .btn{display:block;width:100%;text-align:left;margin:6px 0}
.grid-large{grid-template-columns:repeat(auto-fill,minmax(220px,1fr));}
.grid-medium{grid-template-columns:repeat(auto-fill,minmax(150px,1fr));}
.grid-compact{grid-template-columns:repeat(auto-fill,minmax(100px,1fr));}
@media (max-width:900px){ .thumb-wrap{height:220px} }
@media (max-width:720px){
  .thumb-wrap{height:140px}
  .preview img{width:72px;height:72px}
  .topbar{padding:8px}
  .tools{gap:6px}
  .brand{font-size:15px}
  .menu-toggle{display:inline-block}
  .tools.open .tools-buttons{display:flex;flex-direction:column;position:absolute;right:12px;top:56px;background:#fff;padding:8px;border-radius:8px;border:1px solid #eef2ff;box-shadow:0 8px 20px rgba(0,0,0,0.08)}
  .tools.open .tools-buttons .btn{margin:6px 0}
  .gallery{gap:8px}
}
html,body,#app{max-width:100%;overflow-x:hidden}
.list-item{display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid #f0f3fb}
.list-item .thumb-small{width:80px;height:60px;object-fit:cover;border-radius:6px;background:#f6f8fb}
.list-title{font-weight:600}
.controls-inline{display:flex;gap:8px;align-items:center}
.hidden{display:none!important}
</style>
</head>
<body>
  <header class="topbar" role="banner">
    <div class="brand" id="brand" tabindex="0" title="홈으로">MiniPix — AI 그림 갤러리</div>

    <button id="menuToggle" class="menu-toggle" aria-label="메뉴" title="메뉴">☰</button>

    <div class="tools" role="navigation" aria-label="도구" id="tools">
      <div class="toolbar-search" role="search" aria-label="검색">
        <input id="search" class="input-search" placeholder="검색 (제목/본문/태그/작성자)" aria-label="검색" />
        <select id="sort" class="input-search" style="width:120px" aria-label="정렬">
          <option value="desc">최신순</option>
          <option value="asc">오래된순</option>
        </select>
        <select id="filter" class="input-search" style="width:140px" aria-label="카테고리">
          <option value="all">전체</option>
          <option value="photos">사진</option>
          <option value="board">게시판</option>
        </select>
      </div>

      <div class="tools-buttons" id="toolsButtons">
        <div id="userArea" style="display:none;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;background:#f6f8ff;border:1px solid #e6eefc">
          <span id="userName">Guest</span>
          <button id="myPostsBtn" class="btn" title="내 게시글 보기">내 게시글</button>
          <button id="logoutBtn" class="btn">로그아웃</button>
          <button id="settingsBtn" class="btn hidden" style="display:none">설정</button>
        </div>

        <button id="loginBtn" class="btn">로그인</button>
        <button id="registerBtn" class="btn">회원가입</button>

        <button id="btnNew" class="btn primary">새 글 올리기</button>
        <button id="btnRefresh" class="btn">새로고침</button>

        <div class="grid-toggle" title="썸네일 크기">
          <button id="gridLarge" class="btn">크게</button>
          <button id="gridMedium" class="btn">중간</button>
          <button id="gridCompact" class="btn">작게</button>
        </div>

        <div class="more-toggle">
          <button id="moreBtn" class="btn">더보기 ▾</button>
          <div id="moreMenu" class="more-menu" role="menu">
            <button id="btnExport" class="btn">내보내기</button>
            <label class="btn file" title="가져오기">가져오기<input id="importFile" type="file" accept="application/json" style="display:none" /></label>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="container" id="app" role="main">
    <div class="header-sub">
      <div class="view-toggle" role="tablist" aria-label="뷰 모드">
        <button id="viewPhotos" class="btn primary">사진형</button>
        <button id="viewBoard" class="btn">게시판형</button>
      </div>
      <div style="margin-left:auto" class="small">보기: <span id="currentView">사진형</span></div>
    </div>

    <section id="gallery" class="gallery grid-medium" aria-live="polite"></section>
    <div id="empty" class="empty" style="display:none">게시물이 없습니다. '새 글 올리기'로 시작하세요.</div>
  </main>

  <!-- Editor Modal -->
  <div id="editorModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;padding:12px;z-index:120">
    <div style="width:100%;max-width:760px;background:#fff;border-radius:10px;padding:12px;max-height:90vh;overflow:auto;position:relative">
      <button id="editorClose" style="position:absolute;right:12px;top:12px;border:0;background:#fff;padding:6px;border-radius:6px;cursor:pointer">✕</button>
      <h3 id="editorTitle">새 글 올리기</h3>
      <form id="editorForm" class="editor" onsubmit="return false;">
        <input id="title" placeholder="제목 (선택)" />
        <textarea id="body" rows="6" placeholder="본문"></textarea>

        <div class="row">
          <label class="file">이미지 선택<input id="files" type="file" accept="image/*" multiple style="display:none" /></label>
          <div id="selectedNames" class="small" style="margin-left:8px">선택된 파일 없음</div>
          <div style="margin-left:auto" class="small">최대 200장 권장 • EXIF 제거</div>
        </div>

        <div class="preview" id="preview" aria-live="polite"></div>

        <input id="tags" placeholder="태그 (쉼표 구분)" />
        <div class="row" style="align-items:center">
          <select id="category"><option value="photos">사진</option><option value="board">게시판</option></select>

          <label style="margin-left:8px" title="NSFW 여부를 표시">
            <input id="nsfwCheck" type="checkbox" /> NSFW
          </label>

          <div style="margin-left:auto;display:flex;gap:8px">
            <button id="btnSave" class="btn primary">저장</button>
            <button id="btnSaveClose" class="btn">저장 후 닫기</button>
          </div>
        </div>

        <div id="anonPassRow" style="display:block">
          <label class="small">익명 삭제용 비밀번호 (필수 - 익명 업로드 시)</label>
          <input id="anonPassword" placeholder="익명 글 삭제용 비밀번호" type="password" />
        </div>

        <div id="editorProgress" class="small" style="margin-top:8px"></div>
      </form>
    </div>
  </div>

  <!-- Post View -->
  <div id="postView" style="display:none;padding:12px;max-width:900px;margin:12px auto;z-index:30">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h2 id="postTitleView">제목</h2>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnBack" class="btn">목록</button>
        <button id="btnEditPost" class="btn hidden">편집</button>
        <button id="btnDeletePost" class="btn danger hidden">삭제</button>
      </div>
    </div>

    <div class="post-page" id="postContent" aria-live="polite">
      <div id="metaView" class="small" style="color:var(--muted)"></div>
      <div class="image-stack" id="imageStack"></div>
      <div id="carouselThumbs" class="carousel-thumbs" style="display:none"></div>
      <div id="postBody" class="post-body"></div>
      <div id="postTags" class="tags"></div>
      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <a id="downloadLink" class="btn" href="#" download>원본 다운로드</a>
        <button id="copyBodyBtn" class="btn">본문 복사</button>
        <button id="bulkDownloadBtn" class="btn">일괄 다운로드</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal (Admin only) -->
  <div id="settingsBackdrop" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;padding:12px;z-index:220">
    <div style="background:#fff;padding:14px;border-radius:10px;max-width:520px">
      <h3>설정 (관리자 전용)</h3>
      <label class="small">사이트 소유자 (관리자) 아이디</label>
      <input id="siteOwner" placeholder="owner_username" style="width:100%;margin-bottom:8px"/>
      <div class="small" style="margin-bottom:8px">소유자를 지정하면 그 아이디만 관리자 권한을 가집니다.</div>
      <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end">
        <button id="btnSaveSettings" class="btn primary">저장</button>
        <button id="settingsClose" class="btn">닫기</button>
      </div>
    </div>
  </div>

  <!-- Login Modal (simple) -->
  <div id="loginBackdrop" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;padding:12px;z-index:220">
    <div style="background:#fff;padding:14px;border-radius:10px;max-width:420px">
      <h3>로그인 / 회원가입</h3>
      <input id="authUsername" placeholder="아이디" style="width:100%;margin-bottom:6px"/>
      <input id="authPassword" placeholder="비밀번호" type="password" style="width:100%;margin-bottom:6px"/>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="doRegister" class="btn">회원가입</button>
        <button id="doLogin" class="btn primary">로그인</button>
      </div>
      <div id="authMsg" class="small" style="color:var(--muted);margin-top:8px"></div>
    </div>
  </div>

  <!-- Copy modal -->
  <div id="copyModalBackdrop" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;padding:12px;z-index:200">
    <div style="background:#fff;padding:12px;border-radius:10px;max-width:320px;text-align:center">
      <div>복사 완료!</div>
      <button id="copyModalOk" class="btn primary" style="margin-top:8px">확인</button>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
/*
What's fixed in this file (and why):
- Persistent login: uses localStorage 'minipix_current_user' and restores it at boot before any UI code that could overwrite it.
  setCurrentUser is the single place that writes the localStorage; nothing else clears it except explicit logout.
- Posts visible after refresh: boot awaits openDB() and then calls renderGallery(); renderGallery reads all posts and displays them. No race where UI clears posts before DB loaded.
- Upload works regardless of current view: editorSave no longer depends on gallery being visible and always writes to IndexedDB; a subsequent renderGallery will refresh the UI.
- Enter key on login fields triggers the same login action as clicking 로그인.
- Admins can see posts; NSFW remains hidden only to non-logged-in users. Edit/Delete buttons are shown only when currentUser is author or admin.
- Brand click goes to main gallery only (doesn't touch login).
- Bulk download requires an opened post and now works; openPost sets window.currentOpenPostId.
- Removed global "전체 삭제"; users cannot delete others' posts; admin still can.
- Search includes author username.
*/

(async function main(){
  // All initialization in one place to avoid ordering bugs.
  await openDB();         // ensure DB prepared
  attachEvents();         // attach handlers that don't override user state
  const stored = loadCurrentUser();
  if(stored){
    // Restore user silently before any other UI actions
    setCurrentUser(stored);
  } else {
    setCurrentUser(null);
  }
  applyGridClass();
  applyViewMode();
  await renderGallery();
})();

/* ---------- Helper functions (DB, hashing, URLs) ---------- */
function openDB(){ return new Promise((resolve,reject)=>{ const req=indexedDB.open('minipix-db-v2', 4); req.onupgradeneeded=e=>{ const db=e.target.result; if(!db.objectStoreNames.contains('posts')){ const os=db.createObjectStore('posts',{keyPath:'id'}); os.createIndex('created_at','created_at',{unique:false}); } if(!db.objectStoreNames.contains('users')){ const us=db.createObjectStore('users',{keyPath:'id'}); us.createIndex('username','username',{unique:true}); } }; req.onsuccess=e=>resolve(e.target.result); req.onerror=e=>reject(e.target.error); }); }
async function dbPut(obj,store='posts'){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(store,'readwrite'); tx.objectStore(store).put(obj); tx.oncomplete=()=>res(obj); tx.onerror=e=>rej(e.target.error); }); }
async function dbGetAll(store='posts'){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(store,'readonly'); const r=tx.objectStore(store).getAll(); r.onsuccess=()=>res(r.result||[]); r.onerror=e=>rej(e.target.error); }); }
async function dbGet(id, store='posts'){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(store,'readonly'); const r=tx.objectStore(store).get(id); r.onsuccess=()=>res(r.result); r.onerror=e=>rej(e.target.error); }); }
async function dbDelete(id, store='posts'){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(store,'readwrite'); tx.objectStore(store).delete(id); tx.oncomplete=()=>res(); tx.onerror=e=>rej(e.target.error); }); }

async function hashPassword(pw){ if(window.crypto && crypto.subtle && typeof crypto.subtle.digest === 'function'){ const enc=new TextEncoder(); const buf=await crypto.subtle.digest('SHA-256', enc.encode(pw||'')); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); } else { let h=0; for(let i=0;i<pw.length;i++){ h=((h<<5)-h)+pw.charCodeAt(i); h|=0; } return 'f'+Math.abs(h); } }

const _urls = [];
function makeURL(b){ try{ const u=URL.createObjectURL(b); _urls.push(u); return u; }catch(e){ return ''; } }
function revokeAllURLs(){ try{ _urls.forEach(u=>{ try{ URL.revokeObjectURL(u); }catch(e){} }); _urls.length=0; }catch(e){} }

/* ---------- UI state helpers ---------- */
function saveCurrentUser(u){ if(u) localStorage.setItem('minipix_current_user', JSON.stringify(u)); else localStorage.removeItem('minipix_current_user'); }
function loadCurrentUser(){ try{ const s = localStorage.getItem('minipix_current_user'); return s ? JSON.parse(s) : null; }catch(e){ return null; } }
function getSiteOwner(){ return localStorage.getItem('minipix_site_owner') || ''; }
function setSiteOwner(v){ if(v) localStorage.setItem('minipix_site_owner', v); else localStorage.removeItem('minipix_site_owner'); }

function setCurrentUser(user){
  currentUser = user;
  if(user){
    document.getElementById('userArea').style.display = 'flex';
    document.getElementById('userName').textContent = user.username + (user.role === 'admin' ? ' (관리자)' : '');
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('registerBtn').style.display = 'none';
    document.getElementById('settingsBtn').style.display = user.role === 'admin' ? 'inline-block' : 'none';
  } else {
    document.getElementById('userArea').style.display = 'none';
    document.getElementById('loginBtn').style.display = 'inline-block';
    document.getElementById('registerBtn').style.display = 'inline-block';
    document.getElementById('settingsBtn').style.display = 'none';
  }
  saveCurrentUser(currentUser);
  // ensure editor anon row visibility
  document.getElementById('anonPassRow').style.display = currentUser ? 'none' : 'block';
}

/* ---------- Rendering ---------- */
async function renderGallery(){
  try{
    revokeAllURLs();
    const posts = await dbGetAll('posts');
    let items = posts.sort((a,b)=> a.created_at < b.created_at ? 1 : -1);
    const q = (document.getElementById('search').value || '').trim().toLowerCase();
    const cat = (document.getElementById('filter').value || 'all');

    items = items.filter(p=>{
      if(cat !== 'all' && p.category !== cat) return false;
      if(window.showOnlyMyPosts && (!currentUser || p.authorId !== currentUser.id)) return false;
      if(p.nsfw && !currentUser) return false; // hide nsfw from non-logged-in users
      if(!q) return true;
      return (p.title||'').toLowerCase().includes(q) || (p.body||'').toLowerCase().includes(q) || (p.tags||[]).join(' ').toLowerCase().includes(q) || (p.authorName||'').toLowerCase().includes(q);
    });

    const gallery = document.getElementById('gallery');
    gallery.innerHTML = '';
    if(!items.length){ document.getElementById('empty').style.display = 'block'; gallery.style.display = 'none'; return; }
    document.getElementById('empty').style.display = 'none'; gallery.style.display = 'grid';
    gallery.className = 'gallery ' + gridClass;

    const viewMode = window.viewMode || 'photos';
    if(viewMode === 'board'){
      items.forEach(p=>{
        const li = document.createElement('div'); li.className='list-item';
        if(p.thumbBlobs && p.thumbBlobs.length){
          const img = document.createElement('img'); img.className='thumb-small'; img.src = makeURL(p.thumbBlobs[0]); li.appendChild(img);
        }
        const center = document.createElement('div'); center.style.flex='1';
        const title = document.createElement('div'); title.className='list-title'; title.textContent = p.title || '(제목없음)';
        const meta = document.createElement('div'); meta.className='small'; meta.textContent = `${p.authorName || (p.anon ? '익명' : '비회원')} · ${new Date(p.created_at).toLocaleString()}`;
        center.appendChild(title); center.appendChild(meta);
        li.appendChild(center);
        li.addEventListener('click', ()=> openPost(p.id));
        gallery.appendChild(li);
      });
    } else {
      items.forEach(p=>{
        const card = document.createElement('div'); card.className='card';
        const wrap = document.createElement('div'); wrap.className='thumb-wrap';
        const img = document.createElement('img'); img.className='thumb';
        if(p.thumbBlobs && p.thumbBlobs.length) img.src = makeURL(p.thumbBlobs[0]);
        else img.src = 'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="600" height="400"><rect width="100%" height="100%" fill="#f6f7fb"/></svg>');
        wrap.appendChild(img); card.appendChild(wrap);
        if(p.nsfw) { const nb = document.createElement('div'); nb.className='nsfw-badge'; nb.textContent='NSFW'; card.appendChild(nb); }
        const hover = document.createElement('div'); hover.className='hover';
        const author = p.authorName ? escapeHtml(p.authorName) : (p.anon ? '익명' : '비회원');
        hover.innerHTML = `<div class="title">${p.title?escapeHtml(p.title):'(제목없음)'}</div><div class="meta">${(p.tags||[]).slice(0,3).join(' · ')} · ${author} · ${new Date(p.created_at).toLocaleString()}</div>`;
        card.appendChild(hover);
        card.addEventListener('click', ()=> openPost(p.id));
        gallery.appendChild(card);
      });
    }
  }catch(e){
    console.error('renderGallery failed', e);
    toast('갤러리 로드 중 오류가 발생했습니다 (콘솔 확인)');
  }
}

/* ---------- Open post (sets currentOpenPostId) ---------- */
async function openPost(id){
  try{
    const p = await dbGet(id, 'posts');
    if(!p){ toast('게시물을 찾을 수 없습니다'); return; }
    if(p.nsfw && !currentUser){ alert('NSFW 게시물은 비회원이 볼 수 없습니다. 로그인하세요.'); return; }
    window.currentOpenPostId = id;
    document.getElementById('gallery').style.display='none';
    postView.style.display='block';
    postTitleView.textContent = p.title || '(제목없음)';
    metaView.textContent = `${new Date(p.created_at).toLocaleString()} · ${p.category||''} · ${p.authorName || (p.anon ? '익명' : '비회원')}`;
    imageStack.innerHTML=''; carouselThumbs.innerHTML=''; carouselThumbs.style.display='none';
    if(p.mainBlobs && p.mainBlobs.length){
      p.mainBlobs.forEach((b,idx)=>{
        const wrap = document.createElement('div'); wrap.style.position='relative';
        const img = document.createElement('img'); img.src = makeURL(b); img.style.width='100%'; img.style.height='auto';
        wrap.appendChild(img);
        if(p.nsfw){ const ov = document.createElement('div'); ov.className='nsfw-overlay'; ov.textContent='NSFW — 민감한 콘텐츠'; wrap.appendChild(ov); }
        imageStack.appendChild(wrap);
        const t = document.createElement('img'); t.src = makeURL((p.thumbBlobs && p.thumbBlobs[idx]) ? p.thumbBlobs[idx] : b);
        t.addEventListener('click', ()=> { img.scrollIntoView({behavior:'smooth', block:'center'}); });
        carouselThumbs.appendChild(t);
      });
      if(carouselThumbs.children.length) carouselThumbs.style.display='flex';
    }
    postBodyEl.textContent = p.body || '';
    postTagsEl.innerHTML = ''; (p.tags||[]).forEach(t=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=t; postTagsEl.appendChild(s); });

    downloadLink.href = (p.mainBlobs && p.mainBlobs[0]) ? makeURL(p.mainBlobs[0]) : '#';
    downloadLink.download = (p.title?p.title.replace(/\s+/g,'_'):'image') + '.jpg';

    // show edit/delete only for owner or admin
    const canEdit = currentUser && (currentUser.role === 'admin' || currentUser.id === p.authorId);
    if(canEdit){ btnEditPost.classList.remove('hidden'); btnDeletePost.classList.remove('hidden'); }
    else { btnEditPost.classList.add('hidden'); btnDeletePost.classList.add('hidden'); }
  }catch(e){ console.error('openPost error', e); toast('게시물 열기 실패'); }
}

/* ---------- Close post ---------- */
btnBack.addEventListener('click', ()=> {
  window.currentOpenPostId = null;
  postView.style.display='none';
  document.getElementById('gallery').style.display='grid';
  revokeAllURLs();
});

/* ---------- Editor save (works anywhere) ---------- */
filesInput.addEventListener('change', ()=>{
  const files = Array.from(filesInput.files || []);
  if(!files.length){ selectedNames.textContent='선택된 파일 없음'; previewEl.innerHTML=''; return; }
  selectedNames.textContent = files.map(f=>f.name).join(', ').slice(0,200);
  previewEl.innerHTML=''; files.slice(0,MAX_FILES).forEach(f=>{ const url=URL.createObjectURL(f); const img=document.createElement('img'); img.src=url; previewEl.appendChild(img); _urls.push(url); });
});

btnNew.addEventListener('click', ()=> { editorModal.style.display='flex'; });
editorClose.addEventListener('click', ()=> { editorModal.style.display='none'; });

btnSave.addEventListener('click', ()=> editorSave(false));
btnSaveClose.addEventListener('click', ()=> editorSave(true));

async function editorSave(closeAfter){
  if(!currentUser){
    if(!anonPasswordInput.value || String(anonPasswordInput.value).trim().length < 4){ toast('익명 업로드 시 삭제 비밀번호 필요 (최소4자)'); return; }
  }
  editorProgress.textContent='이미지 처리 중...';
  try{
    const files = Array.from(filesInput.files || []).slice(0,MAX_FILES);
    const mainBlobs = []; const thumbBlobs = [];
    for(const f of files){
      if(!f.type.startsWith('image/')) continue;
      const img = await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=fr.result; }; fr.onerror=rej; fr.readAsDataURL(f); });
      // main resize
      const maxW = 1200;
      const scale = Math.min(1, maxW / img.width);
      const c = document.createElement('canvas'); c.width=Math.round(img.width*scale); c.height=Math.round(img.height*scale);
      c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      const mainBlob = await new Promise(r=>c.toBlob(r, IMAGE_MIME, 0.85));
      // thumb
      const tsize = 300;
      const scale2 = Math.max(tsize / img.width, tsize / img.height);
      const sw = Math.round(img.width*scale2), sh = Math.round(img.height*scale2);
      const tmp = document.createElement('canvas'); tmp.width=sw; tmp.height=sh; tmp.getContext('2d').drawImage(img,0,0,sw,sh);
      const sx = Math.max(0, Math.round((sw-tsize)/2)), sy = Math.max(0, Math.round((sh-tsize)/2));
      const t = document.createElement('canvas'); t.width=tsize; t.height=tsize; t.getContext('2d').drawImage(tmp, sx, sy, tsize, tsize, 0,0,tsize,tsize);
      const thumbBlob = await new Promise(r=>t.toBlob(r, IMAGE_MIME, 0.8));
      mainBlobs.push(mainBlob); thumbBlobs.push(thumbBlob);
    }
    const id = 'p_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8);
    const post = { id, created_at: new Date().toISOString(), title: titleInput.value.trim(), body: bodyInput.value.trim(), tags: (tagsInput.value||'').split(',').map(s=>s.trim()).filter(Boolean), category: categoryInput.value || 'photos', mainBlobs, thumbBlobs, anon: !currentUser, authorId: currentUser ? currentUser.id : null, authorName: currentUser ? currentUser.username : null, anonPassHash: currentUser ? null : await hashPassword(String(anonPasswordInput.value||'')), nsfw: !!nsfwCheck.checked };
    await dbPut(post, 'posts');
    editorProgress.textContent=''; editorModal.style.display='none'; toast('업로드 완료');
    await renderGallery();
    if(closeAfter) openPost(post.id);
  }catch(e){ console.error('editorSave error', e); editorProgress.textContent=''; toast('업로드 실패'); }
}

/* ---------- User functions ---------- */
async function getUserByUsername(username){
  try{ const db = await openDB(); return new Promise((res,rej)=>{ const tx = db.transaction('users','readonly'); const idx = tx.objectStore('users').index('username'); const rq = idx.get(username); rq.onsuccess=()=>res(rq.result||null); rq.onerror=()=>res(null); }); }catch(e){ return null; }
}
async function createUser(username,password){
  username = String(username||'').trim();
  if(!username || !password) throw new Error('아이디/비밀번호 필요');
  if(!/^[a-zA-Z0-9._-]{3,}$/.test(username)) throw new Error('아이디는 3자 이상');
  if(password.length < 4) throw new Error('비밀번호는 4자 이상');
  const existing = await getUserByUsername(username);
  if(existing) throw new Error('이미 존재하는 아이디입니다');
  const users = await dbGetAll('users');
  const owner = getSiteOwner();
  let role = 'user';
  if(owner){ if(username === owner) role = 'admin'; } else { if(users.length === 0) role = 'admin'; }
  const id = 'u_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8);
  const pHash = await hashPassword(password);
  const user = { id, username, passwordHash: pHash, role, profile:{displayName: username, bio:'', avatar:null}, created_at: new Date().toISOString(), resetTokenHash: null };
  await dbPut(user, 'users');
  setCurrentUser({ id: user.id, username: user.username, role: user.role });
  return user;
}
async function authenticateUser(username,password){
  const u = await getUserByUsername(username);
  if(!u) return null;
  const ph = await hashPassword(password);
  if(ph === u.passwordHash) return { id: u.id, username: u.username, role: u.role };
  return null;
}

/* ---------- Login UI / Enter handling ---------- */
document.getElementById('loginBtn').addEventListener('click', ()=>{ authMsg.textContent=''; authUsername.value=''; authPassword.value=''; loginBackdrop.style.display='flex'; authUsername.focus(); });
document.getElementById('registerBtn').addEventListener('click', ()=>{ authMsg.textContent=''; authUsername.value=''; authPassword.value=''; loginBackdrop.style.display='flex'; authUsername.focus(); });

qs('#doRegister').addEventListener('click', async ()=>{
  const username = String(authUsername.value||'').trim();
  const password = String(authPassword.value||'');
  try{ if(username.length<3 || password.length<4){ authMsg.textContent = '아이디 3자/비밀번호 4자 이상 필요'; return; } await createUser(username,password); loginBackdrop.style.display='none'; authMsg.textContent=''; toast('회원가입 및 로그인 완료'); await renderGallery(); }catch(e){ console.error('register', e); authMsg.textContent = e.message || '회원가입 실패'; }
});
qs('#doLogin').addEventListener('click', async ()=>{
  const username = String(authUsername.value||'').trim();
  const password = String(authPassword.value||'');
  try{ const u = await authenticateUser(username,password); if(!u){ authMsg.textContent='아이디 또는 비밀번호 불일치'; return; } setCurrentUser(u); loginBackdrop.style.display='none'; authMsg.textContent=''; toast('로그인 완료'); await renderGallery(); }catch(e){ console.error('login', e); authMsg.textContent='로그인 실패'; }
});
[qs('#authUsername'), qs('#authPassword')].forEach(el=>{ if(!el) return; el.addEventListener('keydown', (ev)=>{ if(ev.key === 'Enter'){ ev.preventDefault(); qs('#doLogin').click(); } }); });

/* ---------- Logout ---------- */
document.getElementById('logoutBtn').addEventListener('click', ()=>{ if(!confirm('로그아웃하시겠습니까?')) return; setCurrentUser(null); saveCurrentUser(null); toast('로그아웃되었습니다'); });

/* ---------- My posts filter ---------- */
window.showOnlyMyPosts = false;
document.getElementById('myPostsBtn').addEventListener('click', ()=>{ if(!currentUser){ toast('로그인 후 사용하세요'); return; } window.showOnlyMyPosts = !window.showOnlyMyPosts; document.getElementById('myPostsBtn').textContent = window.showOnlyMyPosts ? '내 게시글(ON)' : '내 게시글'; renderGallery(); });

/* ---------- Settings ---------- */
document.getElementById('settingsBtn').addEventListener('click', ()=>{ if(!currentUser || currentUser.role !== 'admin'){ toast('설정 접근 권한이 없습니다'); return; } siteOwnerInput.value = getSiteOwner(); settingsBackdrop.style.display='flex'; });
btnSaveSettings.addEventListener('click', ()=>{ if(!currentUser || currentUser.role !== 'admin'){ toast('권한 없음'); settingsBackdrop.style.display='none'; return; } const owner=(siteOwnerInput.value||'').trim(); if(owner) setSiteOwner(owner); else setSiteOwner(''); toast('사이트 소유자 저장됨'); settingsBackdrop.style.display='none'; });
settingsClose.addEventListener('click', ()=> settingsBackdrop.style.display='none');

/* ---------- More menu ---------- */
moreBtn.addEventListener('click', ()=> moreMenu.style.display = moreMenu.style.display === 'block' ? 'none' : 'block');
document.addEventListener('click', (e)=>{ if(!moreBtn.contains(e.target) && !moreMenu.contains(e.target)) moreMenu.style.display='none'; });

/* ---------- Export/Import ---------- */
document.getElementById('btnExport').addEventListener('click', async ()=>{ try{ const posts = await dbGetAll('posts'); const out=[]; for(const p of posts){ const mainBase = p.mainBlobs ? await Promise.all(p.mainBlobs.map(b=>blobToBase64(b))) : null; const thumbBase = p.thumbBlobs ? await Promise.all(p.thumbBlobs.map(b=>blobToBase64(b))) : null; out.push({ id:p.id, title:p.title, body:p.body, tags:p.tags, created_at:p.created_at, category:p.category, authorId:p.authorId||null, authorName:p.authorName||null, anon:p.anon||false, anonPassHash:p.anonPassHash||null, nsfw:!!p.nsfw, mainBase, thumbBase }); } const blob = new Blob([JSON.stringify(out,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='minipix_export.json'; a.click(); URL.revokeObjectURL(url); toast('내보내기 완료'); }catch(e){ console.error('export', e); toast('내보내기 실패'); } });
document.getElementById('importFile').addEventListener('change', async e=>{ const f=e.target.files[0]; if(!f) return; try{ const txt=await f.text(); const arr=JSON.parse(txt); for(const item of arr){ const mainBlobs = item.mainBase ? item.mainBase.map(b=>base64ToBlob(b)) : []; const thumbBlobs = item.thumbBase ? item.thumbBase.map(b=>base64ToBlob(b)) : []; const p = { id: item.id || ('p_'+Date.now()), title: item.title || '', body: item.body || '', tags: item.tags || [], created_at: item.created_at || new Date().toISOString(), category: item.category || 'photos', mainBlobs, thumbBlobs, authorId: item.authorId||null, authorName: item.authorName||null, anon: !!item.anon, anonPassHash: item.anonPassHash||null, nsfw: !!item.nsfw }; await dbPut(p, 'posts'); } toast('가져오기 완료'); await renderGallery(); }catch(err){ console.error('import', err); toast('가져오기 오류'); } finally { e.target.value=''; } });

/* ---------- Utilities ---------- */
function blobToBase64(blob){ return new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result.split(',')[1]); fr.readAsDataURL(blob); }); }
function base64ToBlob(b64,mime='image/jpeg'){ const bin=atob(b64); const len=bin.length; const arr=new Uint8Array(len); for(let i=0;i<len;i++) arr[i]=bin.charCodeAt(i); return new Blob([arr], { type: mime }); }

/* ---------- Close menus on outside click/touch ---------- */
document.addEventListener('click', e=>{ const toolsEl=document.getElementById('tools'); if(!toolsEl.contains(e.target)) toolsEl.classList.remove('open'); if(!moreBtn.contains(e.target) && !moreMenu.contains(e.target)) moreMenu.style.display='none'; });
document.addEventListener('touchstart', ()=>{ document.getElementById('tools').classList.remove('open'); moreMenu.style.display='none'; });

</script>
</body>
</html>
