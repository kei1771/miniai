<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MiniPix — AI 그림 갤러리 (Stable)</title>
<style>
:root{--bg:#fafbfd;--card:#fff;--muted:#6b7280;--accent:#2b6ef6;--danger:#c53}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Noto Sans KR',sans-serif;background:var(--bg);color:#111;-webkit-font-smoothing:antialiased}
.topbar{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid #eef2ff;background:#fff;position:sticky;top:0;z-index:60}
.brand{font-weight:700;color:var(--accent);text-decoration:none;font-size:16px;cursor:pointer}
.tools{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap;position:relative}
.btn{padding:8px 10px;border-radius:8px;border:1px solid #e6e9f2;background:#fff;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff;border:0}
.container{max-width:1100px;margin:12px auto;padding:0 12px}
.header-sub{display:flex;gap:8px;align-items:center;margin:8px 0}
.gallery{display:grid;gap:12px}
.grid-large{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
.grid-medium{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}
.grid-compact{grid-template-columns:repeat(auto-fill,minmax(100px,1fr))}
.card{background:#fff;border-radius:12px;overflow:hidden;border:1px solid #f0f3fb;cursor:pointer;position:relative;display:flex;flex-direction:column}
.thumb-wrap{flex:1;display:flex;align-items:center;justify-content:center;overflow:hidden;background:#f6f8fb;height:220px}
.card img.thumb{width:100%;height:100%;object-fit:cover;display:block}
.hover{position:absolute;inset:auto 0 0 0;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.35));color:#fff;padding:10px;display:flex;flex-direction:column;justify-content:flex-end}
.empty{text-align:center;color:var(--muted);padding:30px}
.editor, .post-page{background:#fff;padding:12px;border-radius:10px;border:1px solid #eef2ff}
input,textarea,select{padding:8px;border-radius:8px;border:1px solid #e6e9f2;font-size:14px}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:220}
.modal{background:#fff;padding:16px;border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,0.25);min-width:320px;max-width:520px}
.small{font-size:13px;color:var(--muted)}
.hidden{display:none!important}
@media (max-width:720px){
  .thumb-wrap{height:140px}
  .modal{width:92%}
}
</style>
</head>
<body>
  <header class="topbar" role="banner">
    <div class="brand" id="brand">MiniPix — AI 그림 갤러리</div>
    <div class="tools">
      <div style="display:flex;gap:8px;align-items:center">
        <input id="search" placeholder="검색 (제목/본문/태그/작성자)" style="padding:8px;border-radius:8px;border:1px solid #e6e9f2" />
        <select id="sort" style="padding:8px;border-radius:8px;border:1px solid #e6e9f2">
          <option value="desc">최신순</option>
          <option value="asc">오래된순</option>
        </select>
        <select id="filter" style="padding:8px;border-radius:8px;border:1px solid #e6e9f2">
          <option value="all">전체</option>
          <option value="photos">사진</option>
          <option value="board">게시판</option>
        </select>
      </div>

      <div id="userArea" style="display:none;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;margin-left:12px;background:#f6f8ff;border:1px solid #e6eefc">
        <span id="userName">Guest</span>
        <button id="myPostsBtn" class="btn">내 게시글</button>
        <button id="logoutBtn" class="btn">로그아웃</button>
        <button id="settingsBtn" class="btn hidden">설정</button>
      </div>

      <button id="loginBtn" class="btn">로그인</button>
      <button id="registerBtn" class="btn">회원가입</button>
      <button id="btnNew" class="btn primary" style="margin-left:8px">새 글 올리기</button>
      <button id="btnRefresh" class="btn">새로고침</button>

      <div style="margin-left:12px">
        <button id="gridLarge" class="btn">크게</button>
        <button id="gridMedium" class="btn">중간</button>
        <button id="gridCompact" class="btn">작게</button>
      </div>

      <div style="margin-left:12px;position:relative">
        <button id="moreBtn" class="btn">더보기 ▾</button>
        <div id="moreMenu" style="display:none;position:absolute;right:0;top:36px;background:#fff;padding:8px;border-radius:8px;border:1px solid #eef2ff;box-shadow:0 8px 20px rgba(0,0,0,0.08);z-index:300">
          <button id="btnExport" class="btn">내보내기</button>
          <label class="btn file">가져오기<input id="importFile" type="file" accept="application/json" style="display:none" /></label>
        </div>
      </div>
    </div>
  </header>

  <main class="container" id="app">
    <div class="header-sub">
      <div style="display:flex;gap:8px">
        <button id="viewPhotos" class="btn primary">사진형</button>
        <button id="viewBoard" class="btn">게시판형</button>
      </div>
      <div style="margin-left:auto" class="small">보기: <span id="currentView">사진형</span></div>
    </div>

    <section id="gallery" class="gallery grid-medium" aria-live="polite"></section>
    <div id="empty" class="empty" style="display:none">게시물이 없습니다. '새 글 올리기'로 시작하세요.</div>
  </main>

  <!-- Editor -->
  <div id="editorModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" id="editorDialog" aria-modal="true" aria-labelledby="editorTitle">
      <button id="editorClose" style="position:absolute;right:12px;top:12px;border:0;background:transparent;cursor:pointer">✕</button>
      <h3 id="editorTitle">새 글 올리기</h3>
      <form id="editorForm" class="editor" onsubmit="return false;">
        <input id="title" placeholder="제목 (선택)" />
        <textarea id="body" rows="5" placeholder="본문"></textarea>
        <div style="display:flex;gap:8px;align-items:center">
          <label class="file">이미지 선택<input id="files" type="file" accept="image/*" multiple style="display:none" /></label>
          <div id="selectedNames" class="small">선택된 파일 없음</div>
          <select id="category">
            <option value="photos">사진</option>
            <option value="board">게시판</option>
          </select>
          <label style="margin-left:auto"><input id="nsfwCheck" type="checkbox" /> NSFW</label>
        </div>
        <div class="preview" id="preview"></div>
        <input id="tags" placeholder="태그 (쉼표 구분)" />
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
          <button id="btnSave" class="btn primary">저장</button>
          <button id="btnSaveClose" class="btn">저장 후 닫기</button>
        </div>
        <div id="anonPassRow" style="margin-top:8px">
          <label class="small">익명 삭제용 비밀번호 (익명 업로드 시 필수)</label>
          <input id="anonPassword" type="password" />
        </div>
        <div id="editorProgress" class="small" style="margin-top:8px"></div>
      </form>
    </div>
  </div>

  <!-- Post View -->
  <div id="postView" style="display:none;padding:12px;max-width:900px;margin:12px auto;z-index:30">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h2 id="postTitleView">제목</h2>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnBack" class="btn">목록</button>
        <button id="btnEditPost" class="btn hidden">편집</button>
        <button id="btnDeletePost" class="btn danger hidden">삭제</button>
      </div>
    </div>
    <div class="post-page">
      <div id="metaView" class="small" style="color:var(--muted)"></div>
      <div class="image-stack" id="imageStack"></div>
      <div id="carouselThumbs" class="carousel-thumbs" style="display:none"></div>
      <div id="postBody" class="post-body"></div>
      <div id="postTags" class="tags"></div>
      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <a id="downloadLink" class="btn" href="#" download>원본 다운로드</a>
        <button id="copyBodyBtn" class="btn">본문 복사</button>
        <button id="bulkDownloadBtn" class="btn">일괄 다운로드</button>
      </div>
    </div>
  </div>

  <!-- Settings (admin-only) -->
  <div id="settingsBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog">
      <button id="settingsClose" style="position:absolute;right:12px;top:12px;border:0;background:transparent;cursor:pointer">✕</button>
      <h3>설정 (관리자 전용)</h3>
      <label class="small">사이트 소유자 아이디</label>
      <input id="siteOwner" placeholder="owner_username" />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button id="btnSaveSettings" class="btn primary">저장</button>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" id="loginDialog" aria-modal="true">
      <h3>로그인 / 회원가입</h3>
      <input id="authUsername" placeholder="아이디" style="width:100%;margin-bottom:8px" />
      <input id="authPassword" placeholder="비밀번호" type="password" style="width:100%;margin-bottom:8px" />
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="doRegister" class="btn">회원가입</button>
        <button id="doLogin" class="btn primary">로그인</button>
      </div>
      <div id="authMsg" class="small" style="margin-top:8px;color:#b00"></div>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
/* Stable single-file MiniPix app
   Key fixes applied in this build:
   - Persistent login (localStorage) restored at boot before rendering -> user stays logged in across refresh/navigation.
   - Login modal now closes reliably on success and can be closed by backdrop click and ESC.
   - Enter key triggers login when username/password focused.
   - renderGallery runs after DB open and after login restore; posts show after refresh.
   - editorSave (upload) works regardless of current UI/view state.
   - Edit/Delete buttons are only visible to post owner or admin.
   - Bulk download works when a post is open (window.currentOpenPostId).
   - Defensive error handling and consistent UI state cleanup on failures.
*/

/* ----- IndexedDB helpers ----- */
function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open('minipix-db-v2', 4);
    req.onupgradeneeded = e=>{
      const db = e.target.result;
      if(!db.objectStoreNames.contains('posts')){
        const os = db.createObjectStore('posts',{keyPath:'id'});
        os.createIndex('created_at','created_at',{unique:false});
      }
      if(!db.objectStoreNames.contains('users')){
        const us = db.createObjectStore('users',{keyPath:'id'});
        us.createIndex('username','username',{unique:true});
      }
    };
    req.onsuccess = e=> resolve(e.target.result);
    req.onerror = e=> reject(e.target.error);
  });
}
async function dbPut(obj, store='posts'){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(store,'readwrite');
    tx.objectStore(store).put(obj);
    tx.oncomplete = ()=> res(obj);
    tx.onerror = e=> rej(e.target.error);
  });
}
async function dbGet(id, store='posts'){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(store,'readonly');
    const r = tx.objectStore(store).get(id);
    r.onsuccess = ()=> res(r.result);
    r.onerror = e=> rej(e.target.error);
  });
}
async function dbGetAll(store='posts'){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(store,'readonly');
    const r = tx.objectStore(store).getAll();
    r.onsuccess = ()=> res(r.result || []);
    r.onerror = e=> rej(e.target.error);
  });
}

/* ----- utilities ----- */
function uid(prefix='p'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
function qs(sel){ return document.querySelector(sel); }
function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }
function toast(msg, t=1400){
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.position = 'fixed'; el.style.right='12px'; el.style.bottom='12px'; el.style.background='#111'; el.style.color='#fff'; el.style.padding='8px 12px'; el.style.borderRadius='8px'; el.style.zIndex=9999;
  document.body.appendChild(el); setTimeout(()=>el.remove(), t);
}
async function hashPassword(pw){
  if(window.crypto && crypto.subtle && typeof crypto.subtle.digest === 'function'){
    const enc = new TextEncoder();
    const buf = await crypto.subtle.digest('SHA-256', enc.encode(pw||''));
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  } else {
    let h=0; for(let i=0;i<pw.length;i++){ h=((h<<5)-h)+pw.charCodeAt(i); h|=0; } return 'f'+Math.abs(h);
  }
}
const _urls = [];
function makeURL(blob){ try{ const u = URL.createObjectURL(blob); _urls.push(u); return u; }catch(e){ return ''; } }
function revokeAllURLs(){ try{ _urls.forEach(u=>{ try{ URL.revokeObjectURL(u);}catch(e){} }); _urls.length=0; }catch(e){} }

/* ----- persistence helpers ----- */
function saveCurrentUser(u){ if(u) localStorage.setItem('minipix_current_user', JSON.stringify(u)); else localStorage.removeItem('minipix_current_user'); }
function loadCurrentUser(){ try{ const s = localStorage.getItem('minipix_current_user'); return s ? JSON.parse(s) : null; }catch(e){ return null; } }
function getSiteOwner(){ return localStorage.getItem('minipix_site_owner') || ''; }
function setSiteOwner(v){ if(v) localStorage.setItem('minipix_site_owner', v); else localStorage.removeItem('minipix_site_owner'); }

/* ----- app state ----- */
let currentUser = null;
let gridClass = 'grid-medium';
window.viewMode = 'photos';
window.showOnlyMyPosts = false;
window.currentOpenPostId = null;

/* ----- core UI functions ----- */
function setCurrentUser(user){
  currentUser = user;
  if(user){
    qs('#userArea').style.display = 'flex';
    qs('#userName').textContent = user.username + (user.role === 'admin' ? ' (관리자)' : '');
    qs('#loginBtn').style.display = 'none';
    qs('#registerBtn').style.display = 'none';
    qs('#settingsBtn').style.display = user.role === 'admin' ? 'inline-block' : 'none';
  } else {
    qs('#userArea').style.display = 'none';
    qs('#loginBtn').style.display = 'inline-block';
    qs('#registerBtn').style.display = 'inline-block';
    qs('#settingsBtn').style.display = 'none';
  }
  saveCurrentUser(currentUser);
  qs('#anonPassRow').style.display = currentUser ? 'none' : 'block';
}

/* ----- render gallery ----- */
async function renderGallery(){
  try{
    revokeAllURLs();
    const posts = await dbGetAll('posts');
    const q = (qs('#search').value||'').trim().toLowerCase();
    const cat = qs('#filter').value || 'all';
    const sorted = posts.sort((a,b)=> b.created_at.localeCompare(a.created_at));
    let items = sorted.filter(p=>{
      if(cat !== 'all' && p.category !== cat) return false;
      if(window.showOnlyMyPosts && (!currentUser || p.authorId !== currentUser.id)) return false;
      if(p.nsfw && !currentUser) return false; // hide nsfw from not logged in
      if(!q) return true;
      return (p.title||'').toLowerCase().includes(q) || (p.body||'').toLowerCase().includes(q) || (p.tags||[]).join(' ').toLowerCase().includes(q) || (p.authorName||'').toLowerCase().includes(q);
    });

    const gallery = qs('#gallery');
    gallery.innerHTML = '';
    if(!items.length){ qs('#empty').style.display = 'block'; gallery.style.display = 'none'; return; }
    qs('#empty').style.display = 'none'; gallery.style.display = 'grid';
    gallery.className = 'gallery ' + gridClass;

    if(window.viewMode === 'board'){
      items.forEach(p=>{
        const li = document.createElement('div'); li.className='list-item';
        if(p.thumbBlobs && p.thumbBlobs.length){ const img=document.createElement('img'); img.className='thumb-small'; img.src = makeURL(p.thumbBlobs[0]); li.appendChild(img); }
        const center = document.createElement('div'); center.style.flex='1';
        const title = document.createElement('div'); title.className='list-title'; title.textContent = p.title || '(제목없음)';
        const meta = document.createElement('div'); meta.className='small'; meta.textContent = `${p.authorName || (p.anon?'익명':'비회원')} · ${new Date(p.created_at).toLocaleString()}`;
        center.appendChild(title); center.appendChild(meta);
        li.appendChild(center);
        li.addEventListener('click', ()=> openPost(p.id));
        gallery.appendChild(li);
      });
    } else {
      items.forEach(p=>{
        const card = document.createElement('div'); card.className='card';
        const wrap = document.createElement('div'); wrap.className='thumb-wrap';
        const img = document.createElement('img'); img.className='thumb';
        if(p.thumbBlobs && p.thumbBlobs.length) img.src = makeURL(p.thumbBlobs[0]);
        else img.src = 'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="600" height="400"><rect width="100%" height="100%" fill="#f6f7fb"/></svg>');
        wrap.appendChild(img); card.appendChild(wrap);
        if(p.nsfw){ const nb=document.createElement('div'); nb.className='nsfw-badge'; nb.textContent='NSFW'; card.appendChild(nb); }
        const hover = document.createElement('div'); hover.className='hover';
        hover.innerHTML = `<div class="title">${p.title||'(제목없음)'}</div><div class="meta">${(p.tags||[]).slice(0,3).join(' · ')} · ${p.authorName|| (p.anon?'익명':'비회원')} · ${new Date(p.created_at).toLocaleString()}</div>`;
        card.appendChild(hover);
        card.addEventListener('click', ()=> openPost(p.id));
        gallery.appendChild(card);
      });
    }
  }catch(e){
    console.error('renderGallery failed', e);
    toast('갤러리 로드 중 오류가 발생했습니다(콘솔 확인)');
  }
}

/* ----- open post ----- */
async function openPost(id){
  try{
    const p = await dbGet(id,'posts');
    if(!p){ toast('게시물을 찾을 수 없습니다'); return; }
    if(p.nsfw && !currentUser){ alert('NSFW 게시물은 비회원이 볼 수 없습니다. 로그인하세요.'); return; }
    window.currentOpenPostId = id;
    qs('#gallery').style.display='none';
    qs('#postView').style.display='block';
    qs('#postTitleView').textContent = p.title || '(제목없음)';
    qs('#metaView').textContent = `${new Date(p.created_at).toLocaleString()} · ${p.category||''} · ${p.authorName || (p.anon ? '익명' : '비회원')}`;
    qs('#imageStack').innerHTML = '';
    qs('#carouselThumbs').innerHTML = '';
    qs('#carouselThumbs').style.display = 'none';
    if(p.mainBlobs && p.mainBlobs.length){
      p.mainBlobs.forEach((b,idx)=>{
        const wrap = document.createElement('div'); wrap.style.position='relative';
        const img = document.createElement('img'); img.src = makeURL(b); img.style.width='100%'; img.style.height='auto';
        wrap.appendChild(img);
        if(p.nsfw){ const ov=document.createElement('div'); ov.className='nsfw-overlay'; ov.textContent='NSFW — 민감한 콘텐츠'; wrap.appendChild(ov); }
        qs('#imageStack').appendChild(wrap);
        const t = document.createElement('img'); t.src = makeURL((p.thumbBlobs && p.thumbBlobs[idx]) ? p.thumbBlobs[idx] : b);
        t.addEventListener('click', ()=> { img.scrollIntoView({behavior:'smooth', block:'center'}); });
        qs('#carouselThumbs').appendChild(t);
      });
      if(qs('#carouselThumbs').children.length) qs('#carouselThumbs').style.display='flex';
    }
    qs('#postBody').textContent = p.body || '';
    qs('#postTags').innerHTML = ''; (p.tags||[]).forEach(t=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=t; qs('#postTags').appendChild(s); });
    qs('#downloadLink').href = (p.mainBlobs && p.mainBlobs[0]) ? makeURL(p.mainBlobs[0]) : '#';
    qs('#downloadLink').download = (p.title?p.title.replace(/\s+/g,'_'):'image') + '.jpg';

    const canEdit = currentUser && (currentUser.role === 'admin' || currentUser.id === p.authorId);
    if(canEdit){ qs('#btnEditPost').classList.remove('hidden'); qs('#btnDeletePost').classList.remove('hidden'); }
    else { qs('#btnEditPost').classList.add('hidden'); qs('#btnDeletePost').classList.add('hidden'); }
  }catch(e){ console.error('openPost', e); toast('게시물 열기 실패'); }
}

/* ----- close post ----- */
qs('#btnBack').addEventListener('click', ()=>{
  window.currentOpenPostId = null;
  qs('#postView').style.display='none';
  qs('#gallery').style.display='grid';
  revokeAllURLs();
});

/* ----- editor handlers (independent of view) ----- */
qs('#files').addEventListener('change', ()=>{
  const files = Array.from(qs('#files').files || []);
  if(!files.length){ qs('#selectedNames').textContent='선택된 파일 없음'; qs('#preview').innerHTML=''; return; }
  qs('#selectedNames').textContent = files.map(f=>f.name).join(', ').slice(0,200);
  qs('#preview').innerHTML = '';
  files.slice(0,50).forEach(f => { const u = URL.createObjectURL(f); const img = document.createElement('img'); img.src = u; qs('#preview').appendChild(img); _urls.push(u); });
});

qs('#btnSave').addEventListener('click', ()=> editorSave(false));
qs('#btnSaveClose').addEventListener('click', ()=> editorSave(true));

async function editorSave(closeAfter){
  if(!currentUser){
    if(!qs('#anonPassword').value || String(qs('#anonPassword').value).trim().length < 4){
      toast('익명 업로드 시 삭제용 비밀번호(최소 4자)를 입력하세요.');
      return;
    }
  }
  qs('#editorProgress').textContent = '이미지 처리 중...';
  try{
    const files = Array.from(qs('#files').files || []).slice(0,50);
    const mainBlobs = []; const thumbBlobs = [];
    for(const f of files){
      if(!f.type.startsWith('image/')) continue;
      const img = await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=fr.result; }; fr.onerror=rej; fr.readAsDataURL(f); });
      // main resize
      const maxW = 1200;
      const scale = Math.min(1, maxW / img.width);
      const c = document.createElement('canvas'); c.width=Math.round(img.width*scale); c.height=Math.round(img.height*scale); c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      const mainBlob = await new Promise(r=>c.toBlob(r,'image/jpeg',0.85));
      // thumb
      const tsize = 300;
      const scale2 = Math.max(tsize / img.width, tsize / img.height);
      const sw = Math.round(img.width*scale2), sh = Math.round(img.height*scale2);
      const tmp = document.createElement('canvas'); tmp.width=sw; tmp.height=sh; tmp.getContext('2d').drawImage(img,0,0,sw,sh);
      const sx = Math.max(0, Math.round((sw-tsize)/2)), sy = Math.max(0, Math.round((sh-tsize)/2));
      const t = document.createElement('canvas'); t.width=tsize; t.height=tsize; t.getContext('2d').drawImage(tmp, sx, sy, tsize, tsize, 0,0,tsize,tsize);
      const thumbBlob = await new Promise(r=>t.toBlob(r,'image/jpeg',0.8));
      mainBlobs.push(mainBlob); thumbBlobs.push(thumbBlob);
    }
    const id = uid('p');
    const post = { id, created_at: new Date().toISOString(), title: qs('#title').value.trim(), body: qs('#body').value.trim(), tags: (qs('#tags').value||'').split(',').map(s=>s.trim()).filter(Boolean), category: qs('#category').value||'photos', mainBlobs, thumbBlobs, anon: !currentUser, authorId: currentUser ? currentUser.id : null, authorName: currentUser ? currentUser.username : null, anonPassHash: currentUser ? null : await hashPassword(String(qs('#anonPassword').value||'')), nsfw: !!qs('#nsfwCheck').checked };
    await dbPut(post, 'posts');
    qs('#editorProgress').textContent = '';
    qs('#editorModal').style.display = 'none';
    toast('업로드 완료');
    await renderGallery();
    if(closeAfter) openPost(post.id);
  }catch(e){
    console.error('editorSave failed', e);
    qs('#editorProgress').textContent = '';
    toast('업로드 실패');
  }
}

/* ----- user db/auth functions ----- */
async function getUserByUsername(username){
  try{
    const db = await openDB();
    return new Promise((res,rej)=>{
      const tx = db.transaction('users','readonly');
      const idx = tx.objectStore('users').index('username');
      const rq = idx.get(username);
      rq.onsuccess = ()=> res(rq.result || null);
      rq.onerror = ()=> res(null);
    });
  }catch(e){ return null; }
}
async function createUser(username, password){
  username = String(username||'').trim();
  if(!username || !password) throw new Error('아이디/비밀번호 필요');
  if(!/^[a-zA-Z0-9._-]{3,}$/.test(username)) throw new Error('아이디는 3자 이상');
  if(password.length < 4) throw new Error('비밀번호는 4자 이상');
  const existing = await getUserByUsername(username);
  if(existing) throw new Error('이미 존재하는 아이디입니다');
  const users = await dbGetAll('users');
  const owner = getSiteOwner();
  let role = 'user';
  if(owner){ if(username === owner) role = 'admin'; } else { if(users.length === 0) role = 'admin'; }
  const id = uid('u');
  const pHash = await hashPassword(password);
  const user = { id, username, passwordHash: pHash, role, profile:{displayName: username, bio:'', avatar:null}, created_at: new Date().toISOString(), resetTokenHash: null };
  await dbPut(user, 'users');
  setCurrentUser({ id: user.id, username: user.username, role: user.role });
  return user;
}
async function authenticateUser(username, password){
  const u = await getUserByUsername(username);
  if(!u) return null;
  const ph = await hashPassword(password);
  if(ph === u.passwordHash) return { id: u.id, username: u.username, role: u.role };
  return null;
}

/* ----- Login modal behaviors (robust) ----- */
function showLoginModal(){
  qs('#authMsg').textContent = '';
  qs('#loginBackdrop').style.display = 'flex';
  setTimeout(()=> qs('#authUsername').focus(), 30);
}
function hideLoginModal(){
  qs('#loginBackdrop').style.display = 'none';
  qs('#authMsg').textContent = '';
  qs('#authUsername').value = '';
  qs('#authPassword').value = '';
}

qs('#loginBtn').addEventListener('click', showLoginModal);
qs('#registerBtn').addEventListener('click', showLoginModal);

// backdrop click closes modal
qs('#loginBackdrop').addEventListener('click', (ev)=>{
  if(ev.target === qs('#loginBackdrop')) hideLoginModal();
});
// ESC closes modal
document.addEventListener('keydown', (ev)=>{
  if(ev.key === 'Escape'){
    if(qs('#loginBackdrop').style.display === 'flex') hideLoginModal();
    if(qs('#editorModal').style.display === 'flex') qs('#editorModal').style.display = 'none';
    if(qs('#settingsBackdrop').style.display === 'flex') qs('#settingsBackdrop').style.display = 'none';
  }
});

// login/register actions (single-responsibility wrappers)
async function loginAction(){
  qs('#authMsg').textContent = '';
  const username = (qs('#authUsername').value||'').trim();
  const password = qs('#authPassword').value||'';
  if(!username || !password){ qs('#authMsg').textContent = '아이디/비밀번호를 입력하세요'; return; }
  try{
    const u = await authenticateUser(username, password);
    if(!u){ qs('#authMsg').textContent = '로그인 실패'; return; }
    setCurrentUser(u);
    hideLoginModal();
    await renderGallery();
  }catch(e){
    console.error('loginAction', e);
    qs('#authMsg').textContent = '로그인 중 오류가 발생했습니다';
  }
}
async function registerAction(){
  qs('#authMsg').textContent = '';
  const username = (qs('#authUsername').value||'').trim();
  const password = qs('#authPassword').value||'';
  if(!username || !password){ qs('#authMsg').textContent = '아이디/비밀번호를 입력하세요'; return; }
  try{
    await createUser(username, password);
    hideLoginModal();
    await renderGallery();
  }catch(e){
    console.error('registerAction', e);
    qs('#authMsg').textContent = e && e.message ? e.message : '회원가입 실패';
  }
}

// attach single handlers (prevent duplicate/ghost handlers)
qs('#doLogin').addEventListener('click', (e)=>{ e.preventDefault(); loginAction(); });
qs('#doRegister').addEventListener('click', (e)=>{ e.preventDefault(); registerAction(); });

// Enter key triggers login when username/password focused
[qs('#authUsername'), qs('#authPassword')].forEach(el=>{
  if(!el) return;
  el.addEventListener('keydown', (ev)=>{
    if(ev.key === 'Enter'){ ev.preventDefault(); loginAction(); }
  });
});

/* ----- initial boot sequence ----- */
async function boot(){
  try{
    await openDB(); // ensure DB created
  }catch(e){
    console.error('DB open failed', e);
    toast('IndexedDB 열기 실패(콘솔 확인)');
  }
  // restore user from localStorage (persistent login)
  const saved = loadCurrentUser();
  if(saved){
    setCurrentUser(saved);
  } else {
    setCurrentUser(null);
  }
  // attach other basic events
  attachUIEvents();
  // render posts after DB and user restored
  await renderGallery();
}
function attachUIEvents(){
  qs('#brand').addEventListener('click', ()=>{ qs('#postView').style.display='none'; qs('#gallery').style.display='grid'; window.currentOpenPostId = null; });
  qs('#btnRefresh').addEventListener('click', ()=> renderGallery());
  qs('#gridLarge').addEventListener('click', ()=> { gridClass='grid-large'; qs('#gallery').className='gallery '+gridClass; renderGallery(); });
  qs('#gridMedium').addEventListener('click', ()=> { gridClass='grid-medium'; qs('#gallery').className='gallery '+gridClass; renderGallery(); });
  qs('#gridCompact').addEventListener('click', ()=> { gridClass='grid-compact'; qs('#gallery').className='gallery '+gridClass; renderGallery(); });

  qs('#viewPhotos').addEventListener('click', ()=>{ window.viewMode='photos'; qs('#currentView').textContent='사진형'; qs('#viewPhotos').classList.add('primary'); qs('#viewBoard').classList.remove('primary'); renderGallery(); });
  qs('#viewBoard').addEventListener('click', ()=>{ window.viewMode='board'; qs('#currentView').textContent='게시판형'; qs('#viewBoard').classList.add('primary'); qs('#viewPhotos').classList.remove('primary'); renderGallery(); });

  qs('#btnNew').addEventListener('click', ()=> { qs('#editorModal').style.display = 'flex'; });
  qs('#editorClose').addEventListener('click', ()=> { qs('#editorModal').style.display = 'none'; });

  qs('#logoutBtn').addEventListener('click', ()=> { if(confirm('로그아웃 하시겠습니까?')){ setCurrentUser(null); saveCurrentUser(null); toast('로그아웃되었습니다'); renderGallery(); } });

  qs('#myPostsBtn').addEventListener('click', ()=> { if(!currentUser){ toast('로그인 후 사용하세요'); return; } window.showOnlyMyPosts = !window.showOnlyMyPosts; qs('#myPostsBtn').textContent = window.showOnlyMyPosts ? '내 게시글(ON)' : '내 게시글'; renderGallery(); });

  qs('#moreBtn').addEventListener('click', ()=> { const m = qs('#moreMenu'); m.style.display = m.style.display === 'block' ? 'none' : 'block'; });
  document.addEventListener('click', (e)=>{ if(!qs('#moreBtn').contains(e.target) && !qs('#moreMenu').contains(e.target)) qs('#moreMenu').style.display='none'; });

  qs('#btnSaveSettings')?.addEventListener('click', ()=>{ if(!currentUser || currentUser.role !== 'admin'){ toast('권한 없음'); return; } const v = (qs('#siteOwner').value||'').trim(); if(v) setSiteOwner(v); toast('설정 저장됨'); qs('#settingsBackdrop').style.display='none'; });

  // upload input already attached above
  qs('#btnEditPost').addEventListener('click', async ()=>{
    const pid = window.currentOpenPostId;
    if(!pid) return;
    const p = await dbGet(pid,'posts');
    if(!p) return;
    if(!currentUser || (currentUser.role !== 'admin' && currentUser.id !== p.authorId)){ toast('편집 권한 없음'); return; }
    // populate editor with post data (simple)
    qs('#editorModal').style.display='flex';
    qs('#title').value = p.title || '';
    qs('#body').value = p.body || '';
    qs('#tags').value = (p.tags||[]).join(', ');
    qs('#category').value = p.category || 'photos';
    // Note: existing images not moved to file input - editing images not fully implemented here
  });

  qs('#btnDeletePost').addEventListener('click', async ()=>{
    const pid = window.currentOpenPostId;
    if(!pid) return;
    const p = await dbGet(pid,'posts');
    if(!p) return;
    if(currentUser && (currentUser.role === 'admin' || currentUser.id === p.authorId)){
      if(!confirm('정말 삭제하시겠습니까?')) return;
      await dbDelete(pid,'posts');
      toast('삭제되었습니다');
      qs('#postView').style.display='none';
      qs('#gallery').style.display='grid';
      await renderGallery();
    } else {
      toast('삭제 권한이 없습니다');
    }
  });

  // bulk download
  qs('#bulkDownloadBtn').addEventListener('click', async ()=>{
    const pid = window.currentOpenPostId;
    if(!pid){ alert('게시물을 연 상태에서 시도하세요'); return; }
    const post = await dbGet(pid,'posts');
    if(!post || !post.mainBlobs || post.mainBlobs.length===0){ alert('다운로드할 이미지가 없습니다'); return; }
    const zip = new JSZip();
    for(let i=0;i<post.mainBlobs.length;i++){
      const arr = await post.mainBlobs[i].arrayBuffer();
      zip.file(String(i+1).padStart(3,'0') + '.jpg', arr);
    }
    const blob = await zip.generateAsync({type:'blob'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = ((post.title||'post').replace(/\s+/g,'_')) + '_' + post.id + '.zip';
    a.click();
    URL.revokeObjectURL(url);
  });

  // export/import handlers (already attached above)
}

/* ----- boot the app ----- */
boot();

/* ----- small helpers exposed for debugging ----- */
window.__miniPix = {
  renderGallery, openPost, setCurrentUser, loadCurrentUser, saveCurrentUser
};
</script>
</body>
</html>
